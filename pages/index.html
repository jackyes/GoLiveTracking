<html lang="en">
   <head>
      <title>Live Tracking</title>
      <link rel="stylesheet" href="./static/leaflet.css" type="text/css">
      <script src="./static/leaflet.js" type="text/javascript"></script>
      <style type="text/css">
         #map{ height: 100% }
      </style>
      <meta http-equiv="refresh" content="{{.MapRefreshTime}}">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
   </head>
   <body>
      <div style="display: flex; justify-content: center;">
         <button onclick="stopLT()">Stop Live Tracking</button>
         <button onclick="location.reload()">Resume Live Tracking</button>
      </div>
         <div id="map"></div>
      <script type="text/javascript">

function getParameterByName(name, url) {
  if (!url) url = window.location.href;
  name = name.replace(/[\[\]]/g, '\\$&');
  var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
      results = regex.exec(url);
  if (!results) return null;
  if (!results[2]) return '';
  return decodeURIComponent(results[2].replace(/\+/g, ' '));
}

         function stopLT(){
            source.close();
         }

         // initialize the map
         var map = L.map('map').setView([{{.DefaultLat}}, {{.DefaultLon}}], {{.DefaultZoom}});
         L.control.scale().addTo(map)
         map.options.minZoom = {{.MinZoom}};
         map.options.maxZoom = {{.MaxZoom}};
         // load a tile layer
         const basemaps = {
         OpenStreetMap: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap<\/a> contributors', subdomains: ['a','b','c']}),
         OpenTopoMap: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {maxZoom: 20, attribution: 'Map data: &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap<\/a>, <a href="http://viewfinderpanoramas.org">SRTM<\/a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap<\/a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA<\/a>)', subdomains: ['a','b','c']}),
         GoogleStreets: L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}',{attribution: '&copy; GoogleMap', maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3']}),
         GoogleHybrid: L.tileLayer('http://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}',{attribution: '&copy; GoogleMap', maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3']}),
         GoogleSat: L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',{attribution: '&copy; GoogleMap', maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3']}),
         GoogleTerrain: L.tileLayer('http://{s}.google.com/vt/lyrs=p&x={x}&y={y}&z={z}',{attribution: '&copy; GoogleMap', maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3']}),
         };

         var overlay = {
         HikingTrails: L.tileLayer('https://tile.waymarkedtrails.org/{id}/{z}/{x}/{y}.png',{id: 'hiking', attribution: '&copy; <a href="http://waymarkedtrails.org">Sarah Hoffmann<\/a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA<\/a>)'}),
         CyclingTrails: L.tileLayer('https://tile.waymarkedtrails.org/{id}/{z}/{x}/{y}.png',{id: 'cycling', attribution: '&copy; <a href="http://waymarkedtrails.org">Sarah Hoffmann<\/a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA<\/a>)'}),
         };

         L.control.layers(basemaps, overlay).addTo(map);
         basemaps.OpenStreetMap.addTo(map);
         var markerGroup = L.layerGroup().addTo(map);

         {{if .ShowOnlyLastPos}}{{else}}
         var latlngs = [
         {{range .Latlonhistory}}  [{{.}}],
         {{end}}
         ];

         var polyline = L.polyline(latlngs, {color: 'red'}).addTo(map);
         // zoom the map to the polyline
         map.fitBounds(polyline.getBounds());
         {{end}}
         {{.Lastpos}}
         var user = getParameterByName('user'); // get the value of the 'user' variable from the query string
         var session = getParameterByName('session'); // get the value of the 'session' variable from the query string
         var source = new EventSource("/events?user=" + user + "&session=" + session)
         source.addEventListener("location", function(event) {
         var data = JSON.parse(event.data);
         markerGroup.clearLayers();
         L.marker([data.lat, data.lng]).addTo(markerGroup);
         latlngs.push([data.lat,data.lng]);
         polyline.setLatLngs(latlngs);
         L.marker([data.lat,data.lng]).addTo(markerGroup).bindPopup('Lat: ' + data.lat + '<br>Lon: ' + data.lng + '<br>Altitude: ' + data.alt + '<br>Speed: ' + data.speed + '<br>Time: ' + data.time + '<br>Bearing: ' + data.bearing + '<br>HDOP: ' + data.hdop).openPopup();
         {{if .ShowPrecisonCircle}}
         var circle = L.circle([data.lat, data.lng], {
         color: 'blue',
         fillColor: '#003',
         fillOpacity: 0.3,
         radius: data.hdop
         }).addTo(markerGroup);
         });
         {{end}}
      </script>
   </body>
</html>
